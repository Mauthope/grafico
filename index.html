<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Eficiência e Resíduo</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f9;
      padding: 20px;
    }

    .container {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .section {
      display: flex;
      justify-content: space-between;
      gap: 20px;
    }

    .part {
      flex: 1;
      background-color: #fff;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
    }

    h2 {
      margin-bottom: 10px;
    }

    .data-form {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 15px;
    }

    .data-form input, .data-form button {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    .data-form button {
      background-color: #4CAF50;
      color: white;
      cursor: pointer;
    }

    .data-form button:hover {
      background-color: #45a049;
    }

    canvas {
      width: 100%;
      max-height: 200px;
      margin: 15px 0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    table, th, td {
      border: 1px solid #ddd;
    }

    th, td {
      padding: 8px;
      text-align: center;
    }
  </style>
</head>
<body>

  <div class="container" id="app">
    <!-- 6 Seções -->
    ${[1, 2, 3, 4, 5, 6].map((section) => `
      <div class="section">
        ${[1, 2, 3].map((part) => `
          <div class="part" id="section${section}-part${part}">
            <h2>Seção ${section} - Parte ${part}</h2>
            <form class="data-form" onsubmit="saveData(event, 'section${section}-part${part}')">
              <input type="date" required>
              <input type="number" placeholder="Eficiência" step="0.1" required>
              <input type="number" placeholder="Resíduo" step="0.1" required>
              <button type="submit">Salvar Dados</button>
            </form>
            <canvas id="chart-section${section}-part${part}"></canvas>
            <h3>Média Eficiência: <span id="avg-efficiency-section${section}-part${part}">0</span></h3>
            <h3>Média Resíduo: <span id="avg-waste-section${section}-part${part}">0</span></h3>
            <table>
              <thead>
                <tr><th>Data</th><th>Eficiência</th><th>Resíduo</th></tr>
              </thead>
              <tbody id="actions-section${section}-part${part}"></tbody>
            </table>
          </div>
        `).join('')}
      </div>
    `).join('')}
  </div>

  <script>
    // Função para salvar dados e atualizar o gráfico e tabelas
    function saveData(event, id) {
      event.preventDefault();

      // Capturar os campos
      const form = event.target;
      const date = form[0].value;
      const efficiency = parseFloat(form[1].value);
      const waste = parseFloat(form[2].value);

      if (!date || isNaN(efficiency) || isNaN(waste)) return;

      // Carregar dados existentes no LocalStorage
      const storedData = JSON.parse(localStorage.getItem(id)) || [];
      storedData.push({ date, efficiency, waste });
      localStorage.setItem(id, JSON.stringify(storedData));

      // Atualizar tabela
      updateTable(id, storedData);

      // Atualizar gráfico e médias
      updateChart(id, storedData);
      updateAverages(id, storedData);

      // Limpar formulário
      form.reset();
    }

    // Função para atualizar tabelas
    function updateTable(id, data) {
      const tbody = document.getElementById(`actions-${id}`);
      tbody.innerHTML = ''; // Limpar tabela
      data.forEach(item => {
        const row = `<tr>
          <td>${item.date}</td>
          <td>${item.efficiency.toFixed(2)}</td>
          <td>${item.waste.toFixed(2)}</td>
        </tr>`;
        tbody.innerHTML += row;
      });
    }

    // Função para atualizar gráfico
    function updateChart(id, data) {
      const ctx = document.getElementById(`chart-${id}`).getContext('2d');
      const labels = data.map(item => item.date);
      const efficiencies = data.map(item => item.efficiency);
      const wastes = data.map(item => item.waste);

      if (window[`${id}Chart`]) window[`${id}Chart`].destroy();

      window[`${id}Chart`] = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            {
              label: 'Eficiência',
              data: efficiencies,
              backgroundColor: 'rgba(75, 192, 192, 0.6)',
            },
            {
              label: 'Resíduo',
              data: wastes,
              backgroundColor: 'rgba(255, 99, 132, 0.6)',
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false
        }
      });
    }

    // Função para calcular médias
    function updateAverages(id, data) {
      const avgEfficiency = data.reduce((sum, item) => sum + item.efficiency, 0) / data.length || 0;
      const avgWaste = data.reduce((sum, item) => sum + item.waste, 0) / data.length || 0;

      document.getElementById(`avg-efficiency-${id}`).innerText = avgEfficiency.toFixed(2);
      document.getElementById(`avg-waste-${id}`).innerText = avgWaste.toFixed(2);
    }

    // Inicializar todas as partes com dados salvos
    window.onload = () => {
      document.querySelectorAll('.part').forEach(part => {
        const id = part.id;
        const storedData = JSON.parse(localStorage.getItem(id)) || [];
        if (storedData.length) {
          updateTable(id, storedData);
          updateChart(id, storedData);
          updateAverages(id, storedData);
        }
      });
    };
  </script>

</body>
</html>
